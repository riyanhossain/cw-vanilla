<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Widget Test - External Loading</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .status {
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      button:hover {
        transform: translateY(-1px);
        opacity: 0.9;
      }
      code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Chat Widget External Test</h1>

      <div class="info status">
        <strong>Test:</strong> Loading chat widget from Cloudflare Pages URL
      </div>

      <div id="widget-status" class="status">
        <strong>Status:</strong> Loading widget from
        <code>https://cw-vanilla.pages.dev/chat-widget.umd.cjs</code>...
      </div>

      <h2>Test Results</h2>
      <div id="test-results"></div>

      <h2>Widget Controls</h2>
      <div class="controls">
        <button class="btn-primary" onclick="openChat()">Open Chat</button>
        <button class="btn-warning" onclick="closeChat()">Close Chat</button>
        <button class="btn-danger" onclick="clearHistory()">
          Clear History
        </button>
        <button class="btn-success" onclick="testAPI()">Test API</button>
      </div>

      <h2>Integration Code</h2>
      <p>If the test passes, you can embed the widget using this code:</p>
      <pre
        style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 5px;
          overflow-x: auto;
        "
      ><code>&lt;script src="https://cw-vanilla.pages.dev/chat-widget.umd.cjs" data-auto-load="true"&gt;&lt;/script&gt;</code></pre>

      <h2>Custom Configuration Example</h2>
      <pre
        style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 5px;
          overflow-x: auto;
        "
      ><code>&lt;script 
  src="https://cw-vanilla.pages.dev/chat-widget.umd.cjs"
  data-auto-load="true"
  data-title="Support Chat"
  data-primary-color="#28a745"
  data-position="bottom-left"
  data-welcome-message="Hello! How can we help you?"
  data-placeholder="Type your question..."
  data-width="350"
  data-height="500"
&gt;&lt;/script&gt;</code></pre>
    </div>

    <!-- Load from Cloudflare Pages -->
    <script>
      let widget = null;
      let loadStartTime = Date.now();

      function updateStatus(message, type = "info") {
        const statusEl = document.getElementById("widget-status");
        statusEl.innerHTML = `<strong>Status:</strong> ${message}`;
        statusEl.className = `${type} status`;
      }

      function addTestResult(test, result, details = "") {
        const resultsEl = document.getElementById("test-results");
        const resultEl = document.createElement("div");
        resultEl.className = `${result ? "success" : "error"} status`;
        resultEl.innerHTML = `
                <strong>${test}:</strong> ${result ? "‚úÖ PASS" : "‚ùå FAIL"}
                ${details ? `<br><small>${details}</small>` : ""}
            `;
        resultsEl.appendChild(resultEl);
      }

      function runTests() {
        // Test 1: Widget class exists
        const hasClass = typeof ChatWidget !== "undefined";
        addTestResult(
          "Widget Class Available",
          hasClass,
          hasClass
            ? "ChatWidget constructor is globally available"
            : "ChatWidget class not found"
        );

        if (hasClass) {
          try {
            // Test 2: Can create widget instance
            widget = new ChatWidget({
              title: "üß™ External Test",
              primaryColor: "#28a745",
              position: "bottom-right",
              welcomeMessage:
                "Hello! This widget was loaded from Cloudflare Pages.",
              placeholder: "Test the external widget...",
              width: 320,
              height: 450,
            });
            addTestResult(
              "Widget Instantiation",
              true,
              "Widget created successfully"
            );

            // Test 3: Widget methods exist
            const hasOpen = typeof widget.open === "function";
            const hasClose = typeof widget.close === "function";
            const hasClear = typeof widget.clearHistory === "function";
            const hasDestroy = typeof widget.destroy === "function";

            addTestResult(
              "Widget Methods",
              hasOpen && hasClose && hasClear && hasDestroy,
              `open: ${hasOpen}, close: ${hasClose}, clear: ${hasClear}, destroy: ${hasDestroy}`
            );

            // Test 4: Styles are injected
            const hasStyles = document.querySelector("style") !== null;
            addTestResult(
              "Styles Injection",
              hasStyles,
              hasStyles
                ? "CSS styles found in document head"
                : "No CSS styles found"
            );

            updateStatus(
              "‚úÖ All tests passed! Widget loaded successfully from Cloudflare Pages.",
              "success"
            );
          } catch (error) {
            addTestResult("Widget Instantiation", false, error.message);
            updateStatus(`‚ùå Error creating widget: ${error.message}`, "error");
          }
        } else {
          updateStatus(
            "‚ùå Widget class not available. Check if script loaded correctly.",
            "error"
          );
        }
      }

      function openChat() {
        if (widget) widget.open();
      }

      function closeChat() {
        if (widget) widget.close();
      }

      function clearHistory() {
        if (widget) {
          widget.clearHistory();
          alert("Chat history cleared!");
        }
      }

      function testAPI() {
        alert(
          "Widget methods available:\\n- widget.open()\\n- widget.close()\\n- widget.clearHistory()\\n- widget.destroy()"
        );
      }

      // Try multiple URLs in order of preference
      const urlsToTry = [
        "./dist/chat-widget.umd.cjs", // Local file first (for testing)
        "https://cw-vanilla.pages.dev/chat-widget.umd.cjs", // Cloudflare Pages
        "http://localhost:8080/dist/chat-widget.umd.cjs", // Dev server fallback
      ];

      let currentUrlIndex = 0;

      function tryLoadScript() {
        if (currentUrlIndex >= urlsToTry.length) {
          updateStatus(
            "‚ùå Failed to load script from all URLs. Please check deployment.",
            "error"
          );
          return;
        }

        const currentUrl = urlsToTry[currentUrlIndex];
        updateStatus(`Attempting to load from: ${currentUrl}`, "info");

        const script = document.createElement("script");
        script.src = currentUrl;

        script.onload = function () {
          const loadTime = Date.now() - loadStartTime;
          updateStatus(
            `‚úÖ Script loaded from ${currentUrl} in ${loadTime}ms. Running tests...`,
            "success"
          );
          setTimeout(runTests, 100);
        };

        script.onerror = function () {
          updateStatus(
            `‚ùå Failed to load from ${currentUrl}. Trying next URL...`,
            "error"
          );
          currentUrlIndex++;
          setTimeout(tryLoadScript, 500); // Try next URL after a short delay
        };

        document.head.appendChild(script);
      }

      // Start loading
      tryLoadScript();

      // Make widget globally accessible for manual testing
      window.testWidget = () => widget;
      console.log(
        "üß™ External widget test loaded. Use window.testWidget() to access the widget instance."
      );
    </script>
  </body>
</html>
